{% comment %}
  GOYOUTATI ä»£è³¼é é¢ v2 - å«æ‰‹å‹•è¼¸å…¥ fallback
{% endcomment %}

<div id="daiko-app">
  <!-- Step 1: è²¼é€£çµ -->
  <div class="daiko-section" id="step-input">
    <h1 class="daiko-title">ğŸ›’ æ—¥æœ¬ä»£è³¼æœå‹™</h1>
    <p class="daiko-subtitle">è²¼ä¸Šæ—¥æœ¬å•†å“é€£çµï¼Œæˆ‘å€‘å¹«ä½ è³¼è²·ï¼</p>

    <div class="daiko-input-wrap">
      <input
        type="url"
        id="daiko-url"
        placeholder="è²¼ä¸Šæ—¥æœ¬å•†å“é€£çµï¼ˆä¾‹ï¼šhttps://www.amazon.co.jp/...ï¼‰"
        autocomplete="off"
      />
      <button id="daiko-search-btn" onclick="daikoSearch()">
        <span class="btn-text">æŸ¥è©¢å•†å“</span>
        <span class="btn-loading" style="display:none;">æŸ¥è©¢ä¸­...</span>
      </button>
    </div>

    <div class="daiko-supported">
      <p>æ”¯æ´ç¶²ç«™ï¼šAmazon JPã€æ¨‚å¤©ã€ZOZOã€BAPEã€Human Madeã€Onitsuka Tiger åŠå…¶ä»–æ—¥æœ¬ç¶²ç«™</p>
    </div>

    <div id="daiko-error" class="daiko-error" style="display:none;"></div>
  </div>

  <!-- Step 1b: æ‰‹å‹•è¼¸å…¥ï¼ˆçˆ¬å–å¤±æ•—æ™‚é¡¯ç¤ºï¼‰ -->
  <div class="daiko-section" id="step-manual" style="display:none;">
    <div class="daiko-manual-card">
      <h2 class="daiko-manual-title">ğŸ“ æ‰‹å‹•å¡«å¯«å•†å“è³‡è¨Š</h2>
      <p class="daiko-manual-subtitle">ç„¡æ³•è‡ªå‹•æŠ“å–æ­¤ç¶²ç«™ï¼Œè«‹æ‰‹å‹•å¡«å¯«ä»¥ä¸‹è³‡è¨Š</p>

      <div class="daiko-manual-url">
        <span>ğŸ”—</span>
        <span id="manual-url-display"></span>
      </div>

      <div class="daiko-form-group">
        <label for="manual-title">å•†å“åç¨± <span class="required">*</span></label>
        <input type="text" id="manual-title" placeholder="è«‹è²¼ä¸Šå•†å“åç¨±" />
      </div>

      <div class="daiko-form-group">
        <label for="manual-price">æ—¥å¹£å”®åƒ¹ï¼ˆç¨è¾¼ï¼‰<span class="required">*</span></label>
        <div class="daiko-price-input-wrap">
          <span class="daiko-price-prefix">Â¥</span>
          <input type="number" id="manual-price" placeholder="ä¾‹ï¼š5313" min="1" />
        </div>
      </div>

      <div class="daiko-form-group">
        <label for="manual-image">å•†å“åœ–ç‰‡ç¶²å€ï¼ˆé¸å¡«ï¼‰</label>
        <input type="url" id="manual-image" placeholder="å³éµåœ–ç‰‡ â†’ è¤‡è£½åœ–ç‰‡ç¶²å€" />
        <p class="daiko-form-hint">åœ¨å•†å“åœ–ç‰‡ä¸ŠæŒ‰å³éµï¼Œé¸ã€Œè¤‡è£½åœ–ç‰‡ç¶²å€ã€è²¼ä¸Š</p>
      </div>

      <div class="daiko-form-group">
        <label for="manual-note">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
        <input type="text" id="manual-note" placeholder="ä¾‹ï¼šè¦ L è™Ÿã€é»‘è‰²" />
      </div>

      <div id="manual-price-preview" class="daiko-price-box" style="display:none;">
        <div class="daiko-price-row">
          <span class="daiko-price-label">æ—¥æœ¬åŸåƒ¹</span>
          <span id="manual-original-price" class="daiko-price-original"></span>
        </div>
        <div class="daiko-price-row daiko-price-main">
          <span class="daiko-price-label">ä»£è³¼å”®åƒ¹</span>
          <span id="manual-selling-price" class="daiko-price-selling"></span>
        </div>
        <div class="daiko-price-row">
          <span class="daiko-price-label">å°å¹£åƒè€ƒ</span>
          <span id="manual-twd-price" class="daiko-price-twd"></span>
        </div>
      </div>

      <div class="daiko-actions">
        <button id="daiko-manual-btn" onclick="daikoManualOrder()" class="daiko-btn-primary">
          <span class="btn-text">ç¢ºèªä»£è³¼ãƒ»å‰å¾€çµå¸³</span>
          <span class="btn-loading" style="display:none;">å»ºç«‹ä¸­...</span>
        </button>
        <button onclick="daikoReset()" class="daiko-btn-secondary">é‡æ–°æŸ¥è©¢</button>
      </div>
    </div>
  </div>

  <!-- Step 2: é¡¯ç¤ºå•†å“è³‡è¨Šï¼ˆè‡ªå‹•æŠ“å–æˆåŠŸï¼‰ -->
  <div class="daiko-section" id="step-preview" style="display:none;">
    <div class="daiko-product-card">
      <div class="daiko-product-image">
        <img id="preview-image" src="" alt="å•†å“åœ–ç‰‡" />
      </div>
      <div class="daiko-product-info">
        <h2 id="preview-title" class="daiko-product-title"></h2>
        <p id="preview-brand" class="daiko-product-brand"></p>

        <div class="daiko-price-box">
          <div class="daiko-price-row">
            <span class="daiko-price-label">æ—¥æœ¬åŸåƒ¹</span>
            <span id="preview-original-price" class="daiko-price-original"></span>
          </div>
          <div class="daiko-price-row daiko-price-main">
            <span class="daiko-price-label">ä»£è³¼å”®åƒ¹</span>
            <span id="preview-selling-price" class="daiko-price-selling"></span>
          </div>
          <div class="daiko-price-row">
            <span class="daiko-price-label">å°å¹£åƒè€ƒ</span>
            <span id="preview-twd-price" class="daiko-price-twd"></span>
          </div>
        </div>

        <div class="daiko-fee-note">
          <p>ä»£è³¼æ‰‹çºŒè²»åŒ…å«ï¼šå•†å“ä»£è³¼ã€å“è³ªç¢ºèªã€åŒ…è£æœå‹™</p>
          <p>â€» åœ‹éš›é‹è²» Â¥1,250/kgï¼Œè²¨åˆ°å¾Œå¦è¡Œè«‹æ¬¾</p>
        </div>

        <div class="daiko-actions">
          <button id="daiko-order-btn" onclick="daikoCreateOrder()" class="daiko-btn-primary">
            <span class="btn-text">ç¢ºèªä»£è³¼ãƒ»å‰å¾€çµå¸³</span>
            <span class="btn-loading" style="display:none;">å»ºç«‹ä¸­...</span>
          </button>
          <button onclick="daikoReset()" class="daiko-btn-secondary">é‡æ–°æŸ¥è©¢</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 3: å®Œæˆ -->
  <div class="daiko-section" id="step-done" style="display:none;">
    <div class="daiko-done-card">
      <div class="daiko-done-icon">âœ…</div>
      <h2>å•†å“å·²å»ºç«‹ï¼</h2>
      <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•å‰å¾€çµå¸³ï¼š</p>
      <a id="daiko-checkout-link" href="#" class="daiko-btn-primary">å‰å¾€çµå¸³é é¢ â†’</a>
      <button onclick="daikoReset()" class="daiko-btn-secondary" style="margin-top:12px;">ç¹¼çºŒä»£è³¼å…¶ä»–å•†å“</button>
    </div>
  </div>
</div>

<style>
  #daiko-app {
    max-width: 800px;
    margin: 0 auto;
    padding: 40px 20px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  .daiko-title { font-size: 28px; font-weight: 700; text-align: center; margin-bottom: 8px; }
  .daiko-subtitle { text-align: center; color: #666; margin-bottom: 32px; font-size: 16px; }

  /* è¼¸å…¥å€ */
  .daiko-input-wrap { display: flex; gap: 12px; margin-bottom: 16px; }
  #daiko-url {
    flex: 1; padding: 14px 18px; font-size: 16px;
    border: 2px solid #e0e0e0; border-radius: 12px; outline: none; transition: border-color 0.2s;
  }
  #daiko-url:focus { border-color: #000; }
  #daiko-search-btn {
    padding: 14px 28px; background: #000; color: #fff; border: none;
    border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;
    white-space: nowrap; transition: opacity 0.2s;
  }
  #daiko-search-btn:hover { opacity: 0.85; }
  #daiko-search-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .daiko-supported { text-align: center; font-size: 13px; color: #999; }
  .daiko-error {
    margin-top: 16px; padding: 12px 16px;
    background: #fff0f0; color: #d32f2f; border-radius: 8px; text-align: center;
  }

  /* æ‰‹å‹•è¼¸å…¥è¡¨å–® */
  .daiko-manual-card {
    background: #fff; border: 1px solid #eee; border-radius: 16px;
    padding: 32px; box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  }
  .daiko-manual-title { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
  .daiko-manual-subtitle { color: #888; font-size: 14px; margin-bottom: 20px; }
  .daiko-manual-url {
    display: flex; align-items: center; gap: 8px;
    padding: 10px 14px; background: #f5f5f5; border-radius: 8px;
    font-size: 13px; color: #666; margin-bottom: 20px;
    word-break: break-all;
  }
  .daiko-form-group { margin-bottom: 16px; }
  .daiko-form-group label {
    display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px;
  }
  .daiko-form-group .required { color: #d32f2f; }
  .daiko-form-group input[type="text"],
  .daiko-form-group input[type="url"],
  .daiko-form-group input[type="number"] {
    width: 100%; padding: 12px 14px; font-size: 16px;
    border: 2px solid #e0e0e0; border-radius: 10px; outline: none;
    transition: border-color 0.2s; box-sizing: border-box;
  }
  .daiko-form-group input:focus { border-color: #000; }
  .daiko-form-hint { font-size: 12px; color: #999; margin-top: 4px; }
  .daiko-price-input-wrap {
    display: flex; align-items: center; gap: 0;
  }
  .daiko-price-prefix {
    padding: 12px 14px; background: #f5f5f5; border: 2px solid #e0e0e0;
    border-right: none; border-radius: 10px 0 0 10px; font-size: 16px; font-weight: 600;
  }
  .daiko-price-input-wrap input {
    border-radius: 0 10px 10px 0 !important;
  }

  /* å•†å“å¡ç‰‡ */
  .daiko-product-card {
    display: flex; gap: 32px; background: #fff;
    border: 1px solid #eee; border-radius: 16px;
    padding: 24px; box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  }
  .daiko-product-image { flex: 0 0 280px; }
  .daiko-product-image img {
    width: 100%; border-radius: 12px; object-fit: contain;
    max-height: 350px; background: #f5f5f5;
  }
  .daiko-product-info { flex: 1; }
  .daiko-product-title { font-size: 18px; font-weight: 600; margin-bottom: 4px; line-height: 1.4; }
  .daiko-product-brand { color: #888; font-size: 14px; margin-bottom: 20px; }

  /* åƒ¹æ ¼å€ */
  .daiko-price-box {
    background: #fafafa; border-radius: 12px; padding: 16px; margin-bottom: 16px;
  }
  .daiko-price-row {
    display: flex; justify-content: space-between; align-items: center; padding: 6px 0;
  }
  .daiko-price-label { color: #666; font-size: 14px; }
  .daiko-price-original { font-size: 14px; color: #999; text-decoration: line-through; }
  .daiko-price-main {
    border-top: 1px solid #eee; border-bottom: 1px solid #eee;
    padding: 10px 0; margin: 4px 0;
  }
  .daiko-price-selling { font-size: 22px; font-weight: 700; color: #d32f2f; }
  .daiko-price-twd { font-size: 14px; color: #888; }
  .daiko-fee-note { font-size: 13px; color: #999; margin-bottom: 20px; line-height: 1.6; }
  .daiko-fee-note p { margin: 2px 0; }

  /* æŒ‰éˆ• */
  .daiko-actions { display: flex; gap: 12px; margin-top: 20px; }
  .daiko-btn-primary {
    flex: 1; padding: 14px 24px; background: #000; color: #fff; border: none;
    border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;
    text-align: center; text-decoration: none; display: inline-block; transition: opacity 0.2s;
  }
  .daiko-btn-primary:hover { opacity: 0.85; color: #fff; }
  .daiko-btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
  .daiko-btn-secondary {
    padding: 14px 24px; background: #f5f5f5; color: #333; border: none;
    border-radius: 12px; font-size: 16px; cursor: pointer; transition: background 0.2s;
  }
  .daiko-btn-secondary:hover { background: #eee; }

  /* å®Œæˆç•«é¢ */
  .daiko-done-card {
    text-align: center; padding: 48px 24px; background: #fff;
    border-radius: 16px; border: 1px solid #eee; box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  }
  .daiko-done-icon { font-size: 48px; margin-bottom: 16px; }

  /* RWD */
  @media (max-width: 640px) {
    .daiko-input-wrap { flex-direction: column; }
    .daiko-product-card { flex-direction: column; }
    .daiko-product-image { flex: none; }
    .daiko-actions { flex-direction: column; }
  }
</style>

<script>
  // ============================================================
  // è¨­å®š
  // ============================================================
  const DAIKO_API_BASE = 'https://goyoutatidaigo.zeabur.app';
  const DAIKO_API_KEY  = 'Wakuwaku';

  // æš«å­˜æŸ¥è©¢çµæœ
  let currentProduct = null;
  let currentPricing = null;

  // å®šåƒ¹è²»ç‡è¡¨ï¼ˆå’Œå¾Œç«¯ config.py ä¸€è‡´ï¼‰
  const PRICING_TIERS = [
    { min: 0,     max: 3000,   rate: 1.40 },
    { min: 3001,  max: 8000,   rate: 1.35 },
    { min: 8001,  max: 20000,  rate: 1.30 },
    { min: 20001, max: 50000,  rate: 1.25 },
    { min: 50001, max: 999999, rate: 1.20 },
  ];
  const MIN_SERVICE_FEE = 300;
  const TWD_RATE = 0.21; // é è¨­åŒ¯ç‡ fallback

  // ============================================================
  // å‰ç«¯å®šåƒ¹è¨ˆç®—ï¼ˆæ‰‹å‹•è¼¸å…¥ç”¨ï¼‰
  // ============================================================
  function calcPrice(originalJpy) {
    let rate = 1.30;
    for (const tier of PRICING_TIERS) {
      if (originalJpy >= tier.min && originalJpy <= tier.max) {
        rate = tier.rate;
        break;
      }
    }
    let fee = Math.floor(originalJpy * (rate - 1));
    if (fee < MIN_SERVICE_FEE) fee = MIN_SERVICE_FEE;
    const selling = originalJpy + fee;
    const twd = Math.floor(selling * TWD_RATE);
    return { original: originalJpy, selling, twd, rate };
  }

  // ============================================================
  // Step 1: æŸ¥è©¢å•†å“
  // ============================================================
  async function daikoSearch() {
    const urlInput = document.getElementById('daiko-url');
    const url = urlInput.value.trim();

    if (!url) { showError('è«‹è²¼ä¸Šå•†å“é€£çµ'); return; }
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
      showError('è«‹è¼¸å…¥å®Œæ•´çš„ç¶²å€ï¼ˆä»¥ http:// æˆ– https:// é–‹é ­ï¼‰');
      return;
    }

    setLoading('daiko-search-btn', true);
    hideError();

    try {
      const resp = await fetch(`${DAIKO_API_BASE}/api/scrape`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': DAIKO_API_KEY,
        },
        body: JSON.stringify({ url }),
      });

      const data = await resp.json();

      if (!data.success || !data.product || !data.product.title) {
        // çˆ¬å–å¤±æ•— â†’ é¡¯ç¤ºæ‰‹å‹•è¼¸å…¥è¡¨å–®
        showManualForm(url);
        return;
      }

      currentProduct = data.product;
      currentPricing = data.pricing;
      showPreview();

    } catch (err) {
      // ä»»ä½•éŒ¯èª¤éƒ½å°å‘æ‰‹å‹•è¼¸å…¥
      showManualForm(url);
      console.error('Daiko search error:', err);
    } finally {
      setLoading('daiko-search-btn', false);
    }
  }

  // ============================================================
  // Step 1b: æ‰‹å‹•è¼¸å…¥è¡¨å–®
  // ============================================================
  function showManualForm(url) {
    document.getElementById('manual-url-display').textContent = url;
    document.getElementById('step-input').style.display = 'none';
    document.getElementById('step-manual').style.display = 'block';

    // åƒ¹æ ¼å³æ™‚é è¦½
    const priceInput = document.getElementById('manual-price');
    priceInput.addEventListener('input', () => {
      const val = parseInt(priceInput.value);
      const previewBox = document.getElementById('manual-price-preview');
      if (val > 0) {
        const p = calcPrice(val);
        document.getElementById('manual-original-price').textContent = `Â¥${p.original.toLocaleString()}`;
        document.getElementById('manual-selling-price').textContent = `Â¥${p.selling.toLocaleString()}`;
        document.getElementById('manual-twd-price').textContent = `â‰ˆ NT$${p.twd.toLocaleString()}`;
        previewBox.style.display = 'block';
      } else {
        previewBox.style.display = 'none';
      }
    });
  }

  // ============================================================
  // æ‰‹å‹•ä¸‹å–®
  // ============================================================
  async function daikoManualOrder() {
    const title = document.getElementById('manual-title').value.trim();
    const priceStr = document.getElementById('manual-price').value.trim();
    const imageUrl = document.getElementById('manual-image').value.trim();
    const note = document.getElementById('manual-note').value.trim();
    const sourceUrl = document.getElementById('manual-url-display').textContent;

    if (!title) { alert('è«‹å¡«å¯«å•†å“åç¨±'); return; }
    if (!priceStr || parseInt(priceStr) <= 0) { alert('è«‹å¡«å¯«æ­£ç¢ºçš„æ—¥å¹£åƒ¹æ ¼'); return; }

    const originalPrice = parseInt(priceStr);
    const pricing = calcPrice(originalPrice);

    setLoading('daiko-manual-btn', true);

    try {
      const resp = await fetch(`${DAIKO_API_BASE}/api/create-manual`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': DAIKO_API_KEY,
        },
        body: JSON.stringify({
          title: note ? `${title}ï¼ˆ${note}ï¼‰` : title,
          price_jpy: pricing.selling,
          original_price_jpy: originalPrice,
          image_url: imageUrl,
          source_url: sourceUrl,
        }),
      });

      const data = await resp.json();

      if (!data.success) {
        alert(data.error || 'å»ºç«‹å•†å“å¤±æ•—');
        return;
      }

      document.getElementById('daiko-checkout-link').href = data.checkout_url;
      document.getElementById('step-manual').style.display = 'none';
      document.getElementById('step-done').style.display = 'block';

    } catch (err) {
      alert('å»ºç«‹å•†å“å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      console.error('Manual order error:', err);
    } finally {
      setLoading('daiko-manual-btn', false);
    }
  }

  // ============================================================
  // Step 2: ç¢ºèªä¸‹å–®ï¼ˆè‡ªå‹•æŠ“å–æˆåŠŸçš„æµç¨‹ï¼‰
  // ============================================================
  async function daikoCreateOrder() {
    if (!currentProduct) return;
    setLoading('daiko-order-btn', true);

    try {
      const resp = await fetch(`${DAIKO_API_BASE}/api/create-order`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': DAIKO_API_KEY,
        },
        body: JSON.stringify({ url: currentProduct.source_url }),
      });

      const data = await resp.json();

      if (!data.success) { showError(data.error || 'å»ºç«‹å•†å“å¤±æ•—'); return; }

      document.getElementById('daiko-checkout-link').href = data.checkout_url;
      document.getElementById('step-preview').style.display = 'none';
      document.getElementById('step-done').style.display = 'block';

    } catch (err) {
      showError('å»ºç«‹å•†å“å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      console.error('Daiko order error:', err);
    } finally {
      setLoading('daiko-order-btn', false);
    }
  }

  // ============================================================
  // UI
  // ============================================================
  function showPreview() {
    const p = currentProduct;
    const pr = currentPricing;

    document.getElementById('preview-title').textContent = p.title || 'å•†å“åç¨±';
    document.getElementById('preview-brand').textContent = p.brand || '';

    if (p.image_url) {
      document.getElementById('preview-image').src = p.image_url;
    }

    if (pr) {
      document.getElementById('preview-original-price').textContent = `Â¥${pr.original_price_jpy.toLocaleString()}`;
      document.getElementById('preview-selling-price').textContent = `Â¥${pr.selling_price_jpy.toLocaleString()}`;
      if (pr.reference_price_twd) {
        document.getElementById('preview-twd-price').textContent = `â‰ˆ NT$${pr.reference_price_twd.toLocaleString()}`;
      }
    } else {
      document.getElementById('preview-original-price').textContent = 'åƒ¹æ ¼éœ€å¦è¡Œå ±åƒ¹';
      document.getElementById('preview-selling-price').textContent = 'è¯ç¹«å®¢æœ';
    }

    document.getElementById('step-input').style.display = 'none';
    document.getElementById('step-preview').style.display = 'block';
  }

  function daikoReset() {
    currentProduct = null;
    currentPricing = null;
    document.getElementById('daiko-url').value = '';
    document.getElementById('step-input').style.display = 'block';
    document.getElementById('step-preview').style.display = 'none';
    document.getElementById('step-manual').style.display = 'none';
    document.getElementById('step-done').style.display = 'none';
    hideError();
  }

  function showError(msg) {
    const el = document.getElementById('daiko-error');
    el.textContent = msg;
    el.style.display = 'block';
  }
  function hideError() {
    document.getElementById('daiko-error').style.display = 'none';
  }
  function setLoading(btnId, loading) {
    const btn = document.getElementById(btnId);
    btn.disabled = loading;
    btn.querySelector('.btn-text').style.display = loading ? 'none' : 'inline';
    btn.querySelector('.btn-loading').style.display = loading ? 'inline' : 'none';
  }

  document.getElementById('daiko-url').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') daikoSearch();
  });
</script>
